FROM debian:bookworm-slim AS base

# set environment variables here with 'ENV VAR=value'
# this allows dynamic customization of container behavior

# update index and install packages if necessary with
RUN apt-get update && apt-get install -y \
    openssl \
    libssl-dev \
    libsqlite3-dev

FROM base AS builder

RUN apt-get install -y \
    build-essential \
    cmake \
    make \
    git \
    python3 && \
    git clone --recurse-submodules https://github.com/open62541/open62541.git

WORKDIR /open62541

# the patch is needed to override the default behavior of the open62541 library
# to treat warnings as errors. Using an old version causes a lot of deprecation
# warnings.
COPY /cmake.patch cmake.patch

# build and patch the vulnerable version of the library
RUN git checkout v1.2.4 && \
    git apply cmake.patch && \
    mkdir build && \
    cd build && \
    cmake .. \ 
      -DCMAKE_BUILD_TYPE=Release \
      -DUA_ENABLE_DA=ON \
      -DUA_ENABLE_DISCOVERY=ON \
      -DUA_ENABLE_ENCRYPTION=ON \
      -DUA_ENABLE_ENCRYPTION_OPENSSL=ON \
      -DUA_ENABLE_METHODCALLS=ON && \
    make && \
    make install && \
    ldconfig /usr/local/bin

COPY /app /app

RUN cd /app && make && make install

FROM base AS runtime

VOLUME /database

COPY --from=builder /usr/local/bin /usr/local/bin

COPY --from=builder /usr/local/lib /usr/local/lib

COPY /pki /pki

# startup is controlled by this script which depends on environment variables
COPY /startup.sh /

ENTRYPOINT [ "usr/bin/env" ]

CMD [ "/bin/sh", "/startup.sh" ]
